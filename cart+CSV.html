<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç‰©è»Š - AiFangKids é¸å“</title>
    
    <style>
        /* ------------------------------------
           é€šç”¨æ¨£å¼èˆ‡è®Šæ•¸ (èˆ‡å…¶ä»–é é¢ä¿æŒä¸€è‡´)
        ------------------------------------ */
        @import url('https://fonts.googleapis.com/css2?family=Huninn&display=swap');

        :root {
            --primary-color: #34495e; 
            --accent-color: #e74c3c; 
            --text-sub: #7f8c8d; 
            --bg-light: #f9f9f9;
            --success-color: #2ecc71; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Huninn', 'Noto Sans TC', Arial, sans-serif;
        }

        body {
            color: var(--primary-color);
            background-color: #fff;
            line-height: 1.5;
            font-size: 14px; 
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }
        
        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ------------------------------------
           é é¦– (Header)
        ------------------------------------ */
        #header {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 0;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .header-icons span {
            font-size: 18px;
            margin-left: 15px;
            cursor: pointer;
        }

        /* ------------------------------------
           è³¼ç‰©è»Šé é¢ä½ˆå±€
        ------------------------------------ */
        .cart-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
        }

        .cart-title {
            font-size: 26px;
            margin-bottom: 30px;
            text-align: center;
        }

        /* æ­¥é©Ÿä¸€ï¼šå•†å“æ¸…å–® */
        .cart-step-1 {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fff;
        }

        .cart-header {
            display: flex;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 15px;
        }

        .col-select, .col-qty, .col-price, .col-delete { width: 10%; text-align: center; }
        .col-info { width: 50%; padding-left: 10px; }

        /* å•†å“åˆ— */
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 4px;
        }

        .item-name {
            font-weight: 700;
            margin-bottom: 5px;
            display: block;
        }
        
        .item-options {
            color: var(--text-sub);
            font-size: 13px;
        }

        .col-qty input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .col-price {
            font-weight: 700;
            color: var(--accent-color);
        }

        .btn-delete {
            color: var(--text-sub);
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-delete:hover {
            opacity: 1;
            color: var(--accent-color);
        }
        
        /* åº•éƒ¨ç¸½è¨ˆ */
        .cart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .total-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .btn-checkout {
            padding: 15px 30px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-checkout:hover {
            background: #2c3e50;
        }

        .empty-cart-message {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: var(--text-sub);
            border: 1px dashed #ccc;
            background-color: var(--bg-light);
        }
        
        /* ------------------------------------
           Footer
        ------------------------------------ */
        #footer {
            margin-top: 60px;
            padding: 40px 0;
            border-top: 1px solid #f0f0f0;
            background-color: #f7f7f7;
        }

        .footer-cols {
            display: flex;
            justify-content: space-around;
            gap: 40px;
            margin-bottom: 30px;
        }

        .customer-center, .company-info {
            flex: 1;
            min-width: 250px;
        }

        .footer-cols h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .footer-cols p {
            margin-bottom: 8px;
            line-height: 1.8;
            color: #777;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #999;
            font-size: 12px;
        }

        /* ------------------------------------
           éŸ¿æ‡‰å¼å„ªåŒ–
        ------------------------------------ */
        @media (max-width: 768px) {
            .cart-container { padding: 10px; margin: 20px auto; }
            .cart-header { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—è¡¨é ­ */
            .cart-item { flex-wrap: wrap; }
            .col-select, .col-qty, .col-price, .col-delete { width: 25%; text-align: center; margin-top: 10px; }
            .col-info { width: 75%; padding-left: 0; }
            .item-image { margin-right: 10px; }
            .btn-checkout { width: 100%; }
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <header id="header">
        <div class="header-inner wrapper">
            <a href="index.html" class="logo">AiFangKids é¸å“</a>
            <div class="header-icons">
                <span onclick="location.href='cart.html'">ğŸ›’</span>
            </div>
        </div>
    </header>

    <div class="cart-container">
        <h1 class="cart-title">è³¼ç‰©è»Š</h1>
        
        <div class="cart-step-1">
            <div class="cart-header">
                <div class="col-select"><input type="checkbox" id="selectAll" onclick="toggleAllSelection(this)"></div>
                <div class="col-info">å•†å“è³‡è¨Š</div>
                <div class="col-qty">æ•¸é‡</div>
                <div class="col-price">å°è¨ˆ</div>
                <div class="col-delete">åˆªé™¤</div>
            </div>

            <div id="cart-list-content">
                <p style="text-align: center; padding: 20px;">è¼‰å…¥è³¼ç‰©è»Šä¸­...</p>
            </div>

            <div id="cart-empty-message" class="empty-cart-message" style="display: none;">
                æ‚¨çš„è³¼ç‰©è»Šä¸­æ²’æœ‰å•†å“ã€‚
                <p style="margin-top: 15px;"><a href="index.html">ç¹¼çºŒè³¼ç‰©</a></p>
            </div>

        </div>

        <div class="cart-footer">
            <div class="total-amount">
                ç¸½é‡‘é¡ï¼š<span id="total-price">0</span> TWD
            </div>
            <button class="btn-checkout">çµå¸³</button>
        </div>
    </div>
    
    <footer id="footer">
        <div class="wrapper footer-cols">
            <div class="customer-center">
                <h3>CUSTOMER CENTER</h3>
                <p>MAIL: aifangkids@gmail.com</p>
                <p>æœå‹™æ™‚é–“: AM 10:00 - PM 21:00</p>
                <p>é€±æœ«èˆ‡åœ‹å®šå‡æ—¥ä¼‘æ¯ï¼Œè¨‚å–®åŠå‡ºè²¨å°‡æ–¼å·¥ä½œæ—¥ç‚ºæ‚¨è™•ç†</p>
            </div>
            <div class="company-info">
                <h3>COMPANY INFO</h3>
                <p>å…¬å¸åç¨±: ç’¦åŠç«¥è£</p>
                <p>çµ±ä¸€ç·¨è™Ÿ: 95294390</p>
            </div>
        </div>
        <div class="copyright wrapper">
            <p>Copyright Â© **Aifang Kids Studio** All rights reserved.</p>
        </div>
    </footer>


    <script>
        const PRODUCT_DATA_CSV = 'SHOP å¾Œç«¯åŠæ™‚æ›´æ–°å•†å“è³‡è¨Š - å•†å“è³‡æ–™.csv';
        let cart = []; // å…¨å±€è³¼ç‰©è»Šé™£åˆ—
        let productCatalogue = {}; // å…¨å±€å•†å“ç›®éŒ„ (ä¾†è‡ª CSV)

        // è³¼ç‰©è»Šå­˜å–å‡½æ•¸ (èˆ‡ detail.html ç›¸åŒ)
        function getCart() {
            const cartData = localStorage.getItem('shoppingCart');
            return cartData ? JSON.parse(cartData) : [];
        }

        function saveCart() {
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
        }
        
        // å¾å°ºå¯¸å­—ä¸²ä¸­æå–åƒ¹æ ¼ (ä¾‹å¦‚: "JS | 7~8y 135~cm ( TWD 630 )" -> 630)
        function extractPriceFromSize(sizeDetail, defaultPrice) {
            const priceMatch = sizeDetail.match(/\( TWD (\d+)\s*\)/);
            return priceMatch ? parseInt(priceMatch[1], 10) : defaultPrice;
        }
        
        // æ¸²æŸ“è³¼ç‰©è»Šåˆ—è¡¨
        function renderCart() {
            const listContentEl = document.getElementById('cart-list-content');
            const emptyMessageEl = document.getElementById('cart-empty-message');
            const totalEl = document.getElementById('total-price');
            let totalAmount = 0;
            let cartHtml = '';

            if (cart.length === 0) {
                listContentEl.style.display = 'none';
                emptyMessageEl.style.display = 'block';
                totalEl.textContent = '0';
                return;
            }
            
            listContentEl.style.display = 'block';
            emptyMessageEl.style.display = 'none';
            
            cart.forEach((item, index) => {
                const productInfo = productCatalogue[item.code] || {};
                
                // ç²å–æœ€çµ‚åƒ¹æ ¼ (å„ªå…ˆä½¿ç”¨å°ºå¯¸ä¸­çš„åŠ åƒ¹ï¼Œå¦å‰‡ä½¿ç”¨ CSV 20% OFF åƒ¹æ ¼)
                const defaultPrice = parseInt(productInfo['åƒ¹æ ¼-20%OFF'] || item.price, 10);
                const finalPrice = extractPriceFromSize(item.sizeDetail, defaultPrice);
                
                const itemSubtotal = finalPrice * item.qty;
                if (item.selected) {
                    totalAmount += itemSubtotal;
                }

                // æ¸…ç†åœ–ç‰‡è·¯å¾‘ (å‡è¨­æ‚¨çš„åœ–ç‰‡å·²åœ¨ GitHub ä¸Š)
                const imageUrl = item.imageUrl ? item.imageUrl.replace(/C:\\Users\\DCT\\OneDrive\\æ¡Œé¢\\flask_shop/i, '').replace(/\\/g, '/') : 'https://via.placeholder.com/80?text=NoImg';


                cartHtml += `
                    <div class="cart-item">
                        <div class="col-select">
                            <input type="checkbox" ${item.selected ? 'checked' : ''} onclick="toggleItemSelection(${index})">
                        </div>
                        
                        <div class="col-info">
                            <img src="${imageUrl}" class="item-image" alt="${item.name}">
                            <div>
                                <a href="detail.html?item_code=${item.code}" class="item-name">${item.name}</a>
                                <div class="item-options">
                                    é¡è‰²: ${item.color} | å°ºå¯¸: ${item.sizeDetail.split('|')[0].trim()}
                                </div>
                            </div>
                        </div>

                        <div class="col-qty">
                            <input type="number" value="${item.qty}" min="1" 
                                onchange="updateQuantity(${index}, this.value)">
                        </div>

                        <div class="col-price">${itemSubtotal} TWD</div>

                        <div class="col-delete">
                            <button class="btn-delete" onclick="removeItem(${index})">âœ•</button>
                        </div>
                    </div>
                `;
            });

            listContentEl.innerHTML = cartHtml;
            totalEl.textContent = totalAmount.toLocaleString('en-US'); // æ ¼å¼åŒ–æ•¸å­—
            
            // æ›´æ–°å…¨é¸ç‹€æ…‹
            const allSelected = cart.length > 0 && cart.every(item => item.selected);
            document.getElementById('selectAll').checked = allSelected;
        }

        // ç§»é™¤å–®ä¸€å•†å“
        window.removeItem = (index) => {
            if (confirm('ç¢ºå®šè¦å¾è³¼ç‰©è»Šç§»é™¤æ­¤å•†å“å—ï¼Ÿ')) {
                cart.splice(index, 1); // ç§»é™¤é™£åˆ—ä¸­çš„é …ç›®
                saveCart();
                renderCart();
            }
        };

        // æ›´æ–°æ•¸é‡
        window.updateQuantity = (index, newQty) => {
            const quantity = parseInt(newQty);
            if (quantity > 0) {
                cart[index].qty = quantity;
                saveCart();
                renderCart();
            }
        };

        // é¸å–å–®ä¸€å•†å“
        window.toggleItemSelection = (index) => {
            cart[index].selected = !cart[index].selected;
            saveCart();
            renderCart(); 
        };
        
        // é¸å–æ‰€æœ‰å•†å“
        window.toggleAllSelection = (checkbox) => {
            const isChecked = checkbox.checked;
            cart = cart.map(item => ({...item, selected: isChecked}));
            saveCart();
            renderCart();
        };


        // ä¸»è¦è¼‰å…¥å‡½æ•¸ï¼šå…ˆè¼‰å…¥ CSVï¼Œå†æ¸²æŸ“è³¼ç‰©è»Š
        function initCart() {
             cart = getCart(); // å…ˆè®€å–æœ¬åœ°è³¼ç‰©è»Šæ•¸æ“š

            Papa.parse(PRODUCT_DATA_CSV, {
                download: true, 
                header: true,   
                skipEmptyLines: true, 
                complete: function(results) {
                    // å°‡å•†å“è³‡æ–™è½‰æ›ç‚ºä»¥ 'è²¨è™Ÿ' ç‚ºéµå€¼çš„ç‰©ä»¶ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾
                    results.data.forEach(item => {
                        if (item['è²¨è™Ÿ']) {
                            productCatalogue[item['è²¨è™Ÿ']] = item;
                        }
                    });
                    
                    renderCart(); // CSV è¼‰å…¥å®Œç•¢å¾Œï¼Œé–‹å§‹æ¸²æŸ“è³¼ç‰©è»Š
                },
                error: (error) => {
                    console.error("è¼‰å…¥å•†å“è³‡æ–™ CSV å¤±æ•—:", error);
                    // å³ä½¿ CSV å¤±æ•—ï¼Œä¹Ÿå˜—è©¦ç”¨ localStorage çš„æ•¸æ“šæ¸²æŸ“
                    renderCart(); 
                }
            });
        }
        
        window.onload = initCart;

        // çµå¸³æŒ‰éˆ• (ç°¡æ˜“æç¤º)
        document.querySelector('.btn-checkout').addEventListener('click', () => {
             const selectedItems = cart.filter(item => item.selected);
             if (selectedItems.length === 0) {
                 alert('è«‹å…ˆé¸æ“‡æ‚¨è¦çµå¸³çš„å•†å“ï¼');
                 return;
             }
             alert(`æº–å‚™çµå¸³ ${selectedItems.length} ä»¶å•†å“ã€‚ç¸½é‡‘é¡: ${document.getElementById('total-price').textContent} TWDã€‚`);
             // å¯¦éš›ç¶²ç«™æœƒå°èˆªåˆ°çµå¸³é é¢
             // window.location.href = 'checkout.html';
        });

    </script>
</body>
</html>